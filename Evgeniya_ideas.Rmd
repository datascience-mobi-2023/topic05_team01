---
title: "Evgeniya ideas"
output: html_document
date: "2023-05-30"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
`````{r}
View(prism)
```

Step1 : Remove the NA values from the columns for the data reduction
median value impute 
```{r}
prism_cleaned <- prism
prism_cleaned[is.na(prism_cleaned)] <- 0
prism_cleaned <- prism_cleaned[complete.cases(prism_cleaned), ]
sum(is.na(prism_cleaned))
dim(prism_cleaned)
```

```{r}
View(prism_cleaned)
```

Step 2: Visualize the data.frame for future data reduction

```{r}
class(prism_cleaned)
typeof(prism_cleaned)
prism_cleaned <- (
  sapply(prism_cleaned, as.numeric)
)
is.numeric(prism_cleaned)
```
```{r}
hist(prism_cleaned)
```

Step 3: We want to remove the drugs, which have positive effect on the cell growth. We want to create a vector which includes more than 200 positive values as column(200 celllines have a postive growth number)

```{r}
positive_cols <- colSums(prism_cleaned > 0) > 200
num_positive_cols <- sum(positive_cols)
num_positive_cols

```
Step 4: We want to remove those columns
```{r}
prism_cleaned <- prism_cleaned[, !positive_cols]
positive_values <- colSums(prism_cleaned > 0) > 0
```

```{r}
dim(prism_cleaned)
View(prism_cleaned)
```


```{r}
heatmap(prism_cleaned)
```


Step 1: Create 5 vectors for the 5 different cancer cell lines


Vector of breast cancer cell lines: 
```{r}
breast.cancer.celllines <- subset(prism.cl, lineage == "breast")

View(breast.cancer.celllines)
```

Vector of gastric cancer cell lines:
```{r}
gastric.cancer.celllines <- subset(prism.cl, lineage == "gastric")

View(gastric.cancer.celllines)
```

Vector of kidney cancer cell lines:
```{r}
kidney.cancer.celllines <- subset(prism.cl, lineage == "kidney")

View(kidney.cancer.celllines)
```

Vector of liver cancer cell lines:
```{r}
liver.cancer.celllines <- subset(prism.cl, lineage == "liver")

View(liver.cancer.celllines)

```

Vector of bone cancer cell lines:
```{r}
bone.cancer.celllines <- subset(prism.cl, lineage == "bone")

View(bone.cancer.celllines)
```


Extract these IDs from prism
```{r}
gastric.cancer.celllines.v <- gastric.cancer.celllines $DepMap_ID

View(gastric.cancer.celllines.v)
```

```{r}
breast.cancer.celllines.v <- breast.cancer.celllines $DepMap_ID

View(breast.cancer.celllines.v)
```

```{r}
kidney.cancer.celllines.v <- kidney.cancer.celllines $DepMap_ID

View(kidney.cancer.celllines.v)
```

```{r}
bone.cancer.celllines.v <- bone.cancer.celllines $DepMap_ID

View(bone.cancer.celllines.v)
```

```{r}
liver.cancer.celllines.v <- liver.cancer.celllines $DepMap_ID

View(liver.cancer.celllines.v)
```

```{r}
cancer.celllines.v <- c(liver.cancer.celllines.v,bone.cancer.celllines.v,kidney.cancer.celllines.v,  breast.cancer.celllines.v,gastric.cancer.celllines.v)

```


```{r}
prism_celllines <- prism[rownames(prism) %in% cancer.celllines.v, ]
View (prism_celllines)

```



Step 2 NA values:
replacing the NA values by the median of the column

```{r}
#First of all, we have to clean the original matrix from the missing values. There are columns that include only missing values, so we cannot replace them with median value, we have to remove them. 
typeof(prism_celllines)
prism_celllines_numeric_2 <- (
  sapply(prism_celllines, as.numeric)
)
is.numeric(prism_celllines_numeric_2)
###removing all columns that have only missing values
prism_celllines_matrix_filtered <- prism_celllines_numeric_2[, colSums(is.na(prism_celllines_numeric_2)) < nrow(prism_celllines_numeric_2)]
###save the names of the rows so we can restore them after that
original_row_names <- rownames(prism_celllines)
###replacing the NAs by median of the columns
prism_celllines_numeric_2[is.na(prism_celllines_numeric_2)] <-median(prism_celllines_numeric_2,na.rm =TRUE)

sum(is.na(prism_celllines_numeric_2))
original_row_names <- rownames(prism_celllines)
###restoring the row names
prism_celllines_matrix_filtered1 <- matrix(prism_celllines_numeric_2, nrow = nrow(prism_celllines), dimnames = list(rownames(prism_celllines), colnames(prism_celllines)))
original_row_names <- rownames(prism_celllines)
prism_celllines_matrix_filtered1 <- matrix(prism_celllines_numeric_2, nrow = nrow(prism_celllines), dimnames = list(rownames(prism_celllines), colnames(prism_celllines)))
typeof(prism_celllines_matrix_filtered1)
class(prism_celllines_matrix_filtered1)
sum(is.na(prism_celllines_matrix_filtered1))###no missing values
####till here is important####


```
2.PCA
```{r}
pca_result_matrix_filtrated1 <- prcomp(prism_celllines_matrix_filtered1)
pca_values <- pca_result_matrix_filtrated1$x # Principal component scores (transformed data)
pca_variances <- pca_result_matrix_filtrated1$sdev^2  # Variance explained by each principal component
pca_proportions <- pca_variances / sum(pca_variances)  # Proportion of variance explained by each principal component
pca_loadings <- pca_result_matrix_filtrated1$rotation  # Loadings (coefficients) of each variable on each principal component
 plot(1:length(pca_variances), pca_variances, type = "b", xlab = "Principal Component", ylab = "Variance Explained",
     main = "Scree Plot")
plot(pca_values[, 1], pca_values[, 2], xlab = "PC1", ylab = "PC2")


###
pca_data <- data.frame(PC1 = pca_values[, 1], PC2 = pca_values[, 2],CellLine = rownames(pca_values) )

bone.cancer.celllines.group<- "red"
kidney.cancer.celllines.group <- "blue"
liver.cancer.celllines.group <- "green"
gastric.cancer.celllines.group<- "purple"
breast.cancer.celllines.group <- "orange"

pca_data$Group <- NA
pca_data$Group[pca_data$CellLine %in% bone.cancer.celllines.v] <- "Group 1"
pca_data$Group[pca_data$CellLine %in% kidney.cancer.celllines.v] <- "Group 2"
pca_data$Group[pca_data$CellLine %in% liver.cancer.celllines.v] <- "Group 3"
pca_data$Group[pca_data$CellLine %in% gastric.cancer.celllines.v] <- "Group 4"
pca_data$Group[pca_data$CellLine %in% breast.cancer.celllines.v]<-"Group 5"
library(ggplot2)
ggplot(pca_data, aes(x = PC1, y = PC2, color = Group)) +
  geom_point() +
  scale_color_manual(values = c(bone.cancer.celllines.group, kidney.cancer.celllines.group, liver.cancer.celllines.group, gastric.cancer.celllines.group, breast.cancer.celllines.group)) +
  labs(x = "PC1", y = "PC2", title = "PCA Scatter Plot")

```

```{r}
typeof(prism_celllines)
prism_celllines_numeric <- (
  sapply(prism_celllines, as.numeric)
)
is.numeric(prism_celllines_numeric)

prism_celllines_numeric[is.na(prism_celllines_numeric)] <-median(prism_celllines_numeric,na.rm =TRUE)

sum(is.na(prism_celllines_numeric))
View(prism_celllines_numeric)
```

```


```{r}
```{r}
##lets create a transposed matrix:
prism_celllines_matrix_transposed<- t(prism_celllines_matrix_filtered1)
sum(is.na(prism_celllines_matrix_filtered1))##there are no missing values, I am so proud
class(prism_celllines_matrix_transposed)
###do not do the following code:
prism_celllines_matrix_transposed <- as.matrix(prism_celllines_matrix_transposed)
prism_celllines_matrix_transposed_copy <- prism_celllines_matrix_transposed
medians <- apply(prism_celllines_matrix_transposed, 1, median, na.rm = TRUE)
prism_celllines_matrix_transposed_copy[is.na(prism_celllines_matrix_transposed)] <- medians[is.na(prism_celllines_matrix_transposed)]
prism_celllines_matrix_transposed[is.na(prism_celllines_matrix_transposed)] <- medians[is.na(prism_celllines_matrix_transposed)]
for (i in 1:nrow(prism_celllines_matrix_transposed)) {
  row_values <- prism_celllines_matrix_transposed[i, ]
row_median <- median(row_values, na.rm = TRUE)
prism_celllines_matrix_transposed_copy[i, is.na(prism_celllines_matrix_transposed[i, ])] <- row_median
}
sum(is.na(prism_celllines_matrix_transposed_copy))
sum(is.na(prism_celllines_matrix_transposed))
is.numeric(prism_celllines_matrix_transposed)

#PCA of transposed matrix:
pca_result_matrix_transposed <- prcomp(prism_celllines_matrix_transposed)
pca_values_t <- pca_result_matrix_transposed$x # Principal component scores (transformed data)
pca_variances_t <- pca_result_matrix_transposed$sdev^2  # Variance explained by each principal component
pca_proportions_t <- pca_variances_t / sum(pca_variances_t)  # Proportion of variance explained by each principal component
pca_loadings_t <- pca_result_matrix_transposed$rotation  # Loadings (coefficients) of each variable on each principal component
plot(1:length(pca_variances_t), pca_variances_t, type = "b", xlab = "Principal Component", ylab = "Variance Explained",main = "Scree Plot")
plot(pca_values_t[, 1], pca_values_t[, 2], xlab = "PC1", ylab = "PC2")
```

##lets create a transposed matrix:
prism_celllines_matrix_transposed<- t(prism_celllines_matrix_filtered1)
sum(is.na(prism_celllines_matrix_filtered1))##there are no missing values, I am so proud
class(prism_celllines_matrix_transposed)
###do not do the following code:
prism_celllines_matrix_transposed <- as.matrix(prism_celllines_matrix_transposed)
prism_celllines_matrix_transposed_copy <- prism_celllines_matrix_transposed
medians <- apply(prism_celllines_matrix_transposed, 1, median, na.rm = TRUE)
prism_celllines_matrix_transposed_copy[is.na(prism_celllines_matrix_transposed)] <- medians[is.na(prism_celllines_matrix_transposed)]
prism_celllines_matrix_transposed[is.na(prism_celllines_matrix_transposed)] <- medians[is.na(prism_celllines_matrix_transposed)]
for (i in 1:nrow(prism_celllines_matrix_transposed)) {
  row_values <- prism_celllines_matrix_transposed[i, ]
row_median <- median(row_values, na.rm = TRUE)
prism_celllines_matrix_transposed_copy[i, is.na(prism_celllines_matrix_transposed[i, ])] <- row_median
}
sum(is.na(prism_celllines_matrix_transposed_copy))
sum(is.na(prism_celllines_matrix_transposed))
is.numeric(prism_celllines_matrix_transposed)

#PCA of transposed matrix:
pca_result_matrix_transposed <- prcomp(prism_celllines_matrix_transposed)
pca_values_t <- pca_result_matrix_transposed$x # Principal component scores (transformed data)
pca_variances_t <- pca_result_matrix_transposed$sdev^2  # Variance explained by each principal component
pca_proportions_t <- pca_variances_t / sum(pca_variances_t)  # Proportion of variance explained by each principal component
pca_loadings_t <- pca_result_matrix_transposed$rotation  # Loadings (coefficients) of each variable on each principal component
plot(1:length(pca_variances_t), pca_variances_t, type = "b", xlab = "Principal Component", ylab = "Variance Explained",main = "Scree Plot")
plot(pca_values_t[, 1], pca_values_t[, 2], xlab = "PC1", ylab = "PC2")

```
PCA for drugs for our gastric cancer cellline:
```{r}
```{r}
prism_gastric_cleaned_treatments_t<- t(prism_gastric_cleaned_treatments)
sum(is.na(prism_gastric_cleaned_treatments_t))
is.numeric(prism_gastric_cleaned_treatments_t)
pca_result_gastric_cleaned_treatments_t<- prcomp(prism_gastric_cleaned_treatments_t)
pca_values_gastric_cleaned_treatments_t <- pca_result_gastric_cleaned_treatments_t$x # Principal component scores (transformed data)
pca_variances_gastric_cleaned_treatments_t <- pca_result_gastric_cleaned_treatments_t$sdev^2  # Variance explained by each principal component
pca_proportions_gastric_cleaned_treatment_t <- pca_variances_gastric_cleaned_treatments_t / sum(pca_variances_gastric_cleaned_treatments_t)  # Proportion of variance explained by each principal component
pca_loadings_gastric_cleaned_treatments_t <- pca_result_gastric_cleaned_treatments_t$rotation  # Loadings (coefficients) of each variable on each principal component
plot(1:length(pca_variances_gastric_cleaned_treatments_t), pca_variances_gastric_cleaned_treatments_t, type = "b", xlab = "Principal Component", ylab = "Variance Explained",main = "Scree Plot")
plot(pca_values_gastric_cleaned_treatments_t[, 1], pca_values_gastric_cleaned_treatments_t[, 2], xlab = "PC1", ylab = "PC2")

```
```{r}

```

prism_gastric_cleaned_treatments_t<- t(prism_gastric_cleaned_treatments)
sum(is.na(prism_gastric_cleaned_treatments_t))
is.numeric(prism_gastric_cleaned_treatments_t)
pca_result_gastric_cleaned_treatments_t<- prcomp(prism_gastric_cleaned_treatments_t)
pca_values_gastric_cleaned_treatments_t <- pca_result_gastric_cleaned_treatments_t$x # Principal component scores (transformed data)
pca_variances_gastric_cleaned_treatments_t <- pca_result_gastric_cleaned_treatments_t$sdev^2  # Variance explained by each principal component
pca_proportions_gastric_cleaned_treatment_t <- pca_variances_gastric_cleaned_treatments_t / sum(pca_variances_gastric_cleaned_treatments_t)  # Proportion of variance explained by each principal component
pca_loadings_gastric_cleaned_treatments_t <- pca_result_gastric_cleaned_treatments_t$rotation  # Loadings (coefficients) of each variable on each principal component
plot(1:length(pca_variances_gastric_cleaned_treatments_t), pca_variances_gastric_cleaned_treatments_t, type = "b", xlab = "Principal Component", ylab = "Variance Explained",main = "Scree Plot")
plot(pca_values_gastric_cleaned_treatments_t[, 1], pca_values_gastric_cleaned_treatments_t[, 2], xlab = "PC1", ylab = "PC2")



```

Examining the correlation between drug concentration and drug response
```{r}
treatment_names <- colnames(prism_gastric_cleaned_treatments)
concentration <- sub(".*::(.*?)::.*", "\\1", treatment_names)
concentration <- as.numeric(concentration)
drug_response_1 <- as.numeric(prism_gastric_cleaned_treatments[1, ])
correlation1_gastric_cleaned_treatments <- cor(concentration, drug_response_1)
print(correlation1_gastric_cleaned_treatments)
plot(concentration, drug_response_1, pch = 16, col = "blue", xlab = "Concentration", ylab = "Drug Response", main = "Correlation Plot")
#Just testing:
 
  #This works:   
correlation_results <- apply(prism_gastric_cleaned_treatments, 1, function(row) {
  drug_response <- as.numeric(row)
  correlation <- cor(concentration, drug_response)
  print(correlation)
  })      
   #conclusion: strong negative correlation: by increasing the concentration, we have stronger drug response   
 
    for (i in 1:nrow(prism_gastric_cleaned_treatments)) {
  drug_response_i <- as.numeric(prism_gastric_cleaned_treatments[i, ])
  correlation <- cor(concentration, drug_response_i)
  plot(concentration, drug_response_i, pch = 16, col = "blue", 
       xlab = "Concentration", ylab = "Drug Response",
       main = paste("Correlation Plot - Row", i, ", Correlation:", correlation))
}
 
hist(correlation_results, main = "Correlation Histogram", xlab = "Correlation")
```
```{r}
3.Perform visualization and clustering steps
```{r}
seurat_object_prism_celllines_t <- NormalizeData(seurat_object_prism_celllines_t)
sum(is.na(seurat_object_prism_celllines_t))
seurat_object_prism_celllines_t <- FindVariableFeatures(seurat_object_prism_celllines_t)
seurat_object_prism_celllines_t <- ScaleData(seurat_object_prism_celllines_t)
seurat_object_prism_celllines_t <- RunPCA(seurat_object_prism_celllines_t, verbose = FALSE)
cbmc <- FindNeighbors(cbmc, dims = 1:30)
cbmc <- FindClusters(cbmc, resolution = 0.8, verbose = FALSE)
cbmc <- RunUMAP(cbmc, dims = 1:30)
DimPlot(cbmc, label = TRUE)
```

```{r}
treatment_names <- colnames(prism_gastric_cleaned_treatments)
concentration <- sub(".*::(.*?)::.*", "\\1", treatment_names)
concentration <- as.numeric(concentration)
drug_response_1 <- as.numeric(prism_gastric_cleaned_treatments[1, ])
correlation1_gastric_cleaned_treatments <- cor(concentration, drug_response_1)
print(correlation1_gastric_cleaned_treatments)
plot(concentration, drug_response_1, pch = 16, col = "blue", xlab = "Concentration", ylab = "Drug Response", main = "Correlation Plot")
#Just testing:
 
  #This works:   
correlation_results <- apply(prism_gastric_cleaned_treatments, 1, function(row) {
  drug_response <- as.numeric(row)
  correlation <- cor(concentration, drug_response)
  print(correlation)
  })      
   #conclusion: strong negative correlation: by increasing the concentration, we have stronger drug response   
 
    for (i in 1:nrow(prism_gastric_cleaned_treatments)) {
  drug_response_i <- as.numeric(prism_gastric_cleaned_treatments[i, ])
  correlation <- cor(concentration, drug_response_i)
  plot(concentration, drug_response_i, pch = 16, col = "blue", 
       xlab = "Concentration", ylab = "Drug Response",
       main = paste("Correlation Plot - Row", i, ", Correlation:", correlation))
}
 
hist(correlation_results, main = "Correlation Histogram", xlab = "Correlation")
```
Important! Calculating the drug concentration and the drug response for each drug: 

```{r}
for (drug_column in colnames(prism_gastric_cleaned_treatments)) {
  drug_name <- strsplit(drug_column, "::")[[1]][1]
  concentration <- concentration 
  for (cell_line in rownames(prism_gastric_cleaned_treatments)) {
    cell_line_data <- prism_gastric_cleaned_treatments[cell_line, drug_column] 
    correlation_df <- cor(cell_line_data, prism_gastric_cleaned_treatments[cell_line, ])
    print(paste("Correlation for", drug_name, "at concentration", concentration, "and", cell_line, ":", correlation))
  }
}

name <- ""
drug_names_prism <- sub("::.*", "", treatment_names)

drug_matrices <- vector("list", length(treatment_names))
#The goal of the code is to find a way to calculate the correlation between each cell line and each drug. I decided to separate each cell lines and to calculate the correlation for each of them with a code separately, but my question is, how to make the "loop" to stop after the end of each drug and to calculate the correlation for each drug
# Loop over each drug
for (j in 1:length(treatment_names)) {
  drug_matrix <- matrix(NA, nrow = nrow(prism_gastric_cleaned_treatments), ncol = sum(grep(treatment_names[j], colnames(prism_gastric_cleaned_treatments))))
  for (i in 1:nrow(prism_gastric_cleaned_treatments)) {
    drug_response_try <- prism_gastric_cleaned_treatments[i, grep(treatment_names[j], colnames(prism_gastric_cleaned_treatments))]
    drug_matrix[i, ] <- drug_response_try
  }
  drug_matrices[[j]] <- drug_matrix
}

drug_vectors <- list()  # Create an empty list to store the vectors

for (j in 1:length(treatment_names)) {
  drug_vector <- numeric(length = nrow(prism_gastric_cleaned_treatments))  
  for (i in 1:nrow(prism_gastric_cleaned_treatments)) {
    drug_response_try <- prism_gastric_cleaned_treatments[i, grep(treatment_names[j], colnames(prism_gastric_cleaned_treatments))]
    drug_vector[i] <- drug_response_try
  }
  drug_vectors[[j]] <- drug_vector 
}

drug_matrices <- vector("list", length(treatment_names))

# Loop over each drug
for (j in 1:length(treatment_names)) {
  drug_name <- treatment_names[j]
  drug_matrix <- matrix(NA, nrow = nrow(prism_gastric_cleaned_treatments), ncol = sum(grep(drug_name, colnames(prism_gastric_cleaned_treatments))))
  
  # Loop over each row in prism_gastric_cleaned_treatments
  for (i in 1:nrow(prism_gastric_cleaned_treatments)) {
    drug_response_try <- prism_gastric_cleaned_treatments[i, grep(drug_name, colnames(prism_gastric_cleaned_treatments))]
    drug_matrix[i, ] <- drug_response_try
  }
  
  drug_matrices[[j]] <- drug_matrix
}
```

#drug correlation only of the most importnat drugs
```{r}
treatment_names_new <- rownames(prism_treat_new)

drug_names_prism_new <- sub("::.*", "", treatment_names_new)

selected_columns_new <- prism_gastric_cleaned_treatments[, grepl(paste(drug_names_prism_new, collapse = "|"), colnames(prism_gastric_cleaned_treatments))]

treatment_names_new_selected <- colnames(selected_columns_new)

concentration_new <- sub(".*::(.*?)::.*", "\\1", treatment_names_new_selected)
concentration_new <- as.numeric(concentration_new)
drug_response_1_new <- as.numeric(selected_columns_new[1, ]) #this is only of the first row.

correlations_new1 <- apply(selected_columns_new[, 1:8], 1, function(x) cor(x[1:8], concentration_new[1:8]))
print(correlations_new1)

correlations_new1 <- apply(selected_columns_new[, 1:8], 1, function(x) cor(x, concentration_new[1:8]))
print(correlations_new1)
correlation1_new <- cor(concentration_new, drug_response_1_new)
print(correlation1_new)
plot(concentration_new[1:8], drug_response_1_new[1:8], pch = 16, col = "blue", xlab = "Concentration", ylab = "Drug Response", main = "Correlation Plot")


#for the first drug
correlation_results_new1 <- vector()
for (i in 1:nrow(selected_columns_new)) {
  drug_response_i_new <- as.numeric(selected_columns_new[i, ])
  correlation_new_1_gastric <- cor(concentration_new[1:8], drug_response_i_new[1:8])
  plot(concentration_new[1:8], drug_response_i_new[1:8], pch = 16, col = "blue", 
       xlab = "Concentration", ylab = "Drug Response",
       main = paste("Correlation Plot - Row", i, ", Correlation:", correlation))
  
  correlation_results_new1 <- c(correlation_results_new1, correlation_new_1_gastric)
}

hist(correlation_results_new1, main = "Correlation Histogram", xlab = "Correlation")

#for the second drug
correlation_results_new2 <- vector()
for (i in 1:nrow(selected_columns_new)) {
  drug_response_i_new <- as.numeric(selected_columns_new[i, ])
  correlation_new_2_gastric <- cor(concentration_new[9:15], drug_response_i_new[9:15])
  plot(concentration_new[9:15], drug_response_i_new[9:15], pch = 16, col = "blue", 
       xlab = "Concentration", ylab = "Drug Response",
       main = paste("Correlation Plot - Row", i, ", Correlation:", correlation_new_2_gastric))
  
  correlation_results_new2 <- c(correlation_results_new2, correlation_new_2_gastric)
}

hist(correlation_results_new2, main = "Correlation Histogram", xlab = "Correlation")

#for the third drug:
correlation_results_new3 <- vector()
for (i in 1:nrow(selected_columns_new)) {
  drug_response_i_new <- as.numeric(selected_columns_new[i, ])
  correlation_new_3_gastric <- cor(concentration_new[16:23], drug_response_i_new[16:23])
  plot(concentration_new[16:23], drug_response_i_new[16:23], pch = 16, col = "blue", 
       xlab = "Concentration", ylab = "Drug Response",
       main = paste("Correlation Plot - Row", i, ", Correlation:", correlation_new_3_gastric))
  
  correlation_results_new3 <- c(correlation_results, correlation_new_3_gastric)
}

hist(correlation_results_new3, main = "Correlation Histogram", xlab = "Correlation")

#for the 4th drug:
correlation_results_new4 <- vector()
for (i in 1:nrow(selected_columns_new)) {
  drug_response_i_new <- as.numeric(selected_columns_new[i, ])
  correlation_new_4_gastric <- cor(concentration_new[24:28], drug_response_i_new[24:28])
  plot(concentration_new[24:28], drug_response_i_new[24:28], pch = 16, col = "blue", 
       xlab = "Concentration", ylab = "Drug Response",
       main = paste("Correlation Plot - Row", i, ", Correlation:", correlation_new_4_gastric))
  
  correlation_results_new4 <- c(correlation_results_new4, correlation_new_4_gastric)
}

hist(correlation_results_new4, main = "Correlation Histogram", xlab = "Correlation")


```
Now only for drugs with strong negative correlation:
```{r}
drugs_names <- colnames(selected_drugs)
concentration_seld<- sub(".*::(.*?)::.*", "\\1", drugs_names)
concentration_seld <- as.numeric(concentration_seld)
drug_response_1_seld <- as.numeric(selected_drugs[1, ])
correlation1_gastric_selected_drugs <- cor(concentration_seld, drug_response_1_seld)
print(correlation1_gastric_selected_drugs)
plot(concentration_seld, drug_response_1_seld, pch = 16, col = "blue", xlab = "Concentration", ylab = "Drug Response", main = "Correlation Plot")
#Just testing:
 
  #This works:   
correlation_results_seld <- apply(selected_drugs, 1, function(row) {
  drug_response_seld <- as.numeric(row)
  correlation_seld <- cor(concentration_seld, drug_response_seld)
  print(correlation_seld)
  })      
   #conclusion: strong negative correlation: by increasing the concentration, we have stronger drug response   
 
    for (i in 1:nrow(selected_drugs)) {
  drug_response_i_seld <- as.numeric(selected_drugs[i, ])
  correlation_seld <- cor(concentration_seld, drug_response_i_seld)
  plot(concentration_seld, drug_response_i_seld, pch = 16, col = "blue", 
       xlab = "Concentration", ylab = "Drug Response",
       main = paste("Correlation Plot - Row", i, ", Correlation:", correlation_seld))
}
 
hist(correlation_results_seld, main = "Correlation Histogram", xlab = "Correlation")
```
Calculating the correlation of only the HDAC inhibitors
```{r}
HDAC_inhibitor_v <- subset(prism_treat_new, moa == "HDAC inhibitor")

HDAC_names_new <- rownames(HDAC_inhibitor_v)

HDAC_names_prism_new <- sub("::.*", "", HDAC_names_new)

HDAC_inhibitor_df <- prism_gastric_cleaned_treatments[, grepl(paste(HDAC_names_prism_new, collapse = "|"), colnames(prism_gastric_cleaned_treatments))]


HDAC_names_new_selected <- colnames(HDAC_inhibitor_df)

HDAC_concentration <- sub(".*::(.*?)::.*", "\\1", HDAC_names_new_selected)
HDAC_concentration <- as.numeric(HDAC_concentration)


#for the first drug
correlation_results_HDAC1 <- vector()
for (i in 1:nrow(HDAC_inhibitor_df)) {
  drug_response_i_new_HDAC <- as.numeric(HDAC_inhibitor_df[i, ])
  correlation_new_1_HDAC <- cor(HDAC_concentration[1:7], drug_response_i_new_HDAC[1:7])
  plot(HDAC_concentration[1:7], drug_response_i_new_HDAC[1:7], pch = 16, col = "blue", 
       xlab = "Concentration", ylab = "Drug Response",
       main = paste("Correlation Plot - Row", i, ", Correlation:", correlation_new_1_HDAC))
  
  correlation_results_HDAC1 <- c(correlation_results_HDAC1, correlation_new_1_HDAC)
}

hist(correlation_results_HDAC1, main = "Correlation Histogram of BRD-K12867552-001-04-7", xlab = "Correlation")


#for the second drug
correlation_results_HDAC2 <- vector()
for (i in 1:nrow(HDAC_inhibitor_df)) {
  drug_response_i_new_HDAC <- as.numeric(HDAC_inhibitor_df[i, ])
  correlation_new_2_HDAC <- cor(HDAC_concentration[8:15], drug_response_i_new_HDAC[8:15])
  plot(HDAC_concentration[8:15], drug_response_i_new_HDAC[8:15], pch = 16, col = "blue", 
       xlab = "Concentration", ylab = "Drug Response",
       main = paste("Correlation Plot - Row", i, ", Correlation:", correlation_new_2_HDAC))
  
  correlation_results_HDAC2 <- c(correlation_results_HDAC2, correlation_new_2_HDAC)
}

hist(correlation_results_HDAC2, main = "Correlation Histogram of BRD-K13167095-001-02-9", xlab = "Correlation")

#for drug 3

correlation_results_HDAC3 <- vector()
for (i in 1:nrow(HDAC_inhibitor_df)) {
  drug_response_i_new_HDAC <- as.numeric(HDAC_inhibitor_df[i, ])
  correlation_new_3_HDAC <- cor(HDAC_concentration[16:23], drug_response_i_new_HDAC[16:23])
  plot(HDAC_concentration[16:23], drug_response_i_new_HDAC[16:23], pch = 16, col = "blue", 
       xlab = "Concentration", ylab = "Drug Response",
       main = paste("Correlation Plot - Row", i, ", Correlation:", correlation_new_3_HDAC))
  
  correlation_results_HDAC3 <- c(correlation_results_HDAC3, correlation_new_3_HDAC)
}

hist(correlation_results_HDAC3, main = "Correlation Histogram of BRD-K13810148-311-03-2", xlab = "Correlation")

#drug 4

correlation_results_HDAC4 <- vector()
for (i in 1:nrow(HDAC_inhibitor_df)) {
  drug_response_i_new_HDAC <- as.numeric(HDAC_inhibitor_df[i, ])
  correlation_new_4_HDAC <- cor(HDAC_concentration[24:31], drug_response_i_new_HDAC[24:31])
  plot(HDAC_concentration[24:31], drug_response_i_new_HDAC[24:31], pch = 16, col = "blue", 
       xlab = "Concentration", ylab = "Drug Response",
       main = paste("Correlation Plot - Row", i, ", Correlation:", correlation_new_4_HDAC))
  
  correlation_results_HDAC4 <- c(correlation_results_HDAC4, correlation_new_4_HDAC)
}

hist(correlation_results_HDAC4, main = "Correlation Histogram of RD-K17743125-001-08-4", xlab = "Correlation")


#for drug 5
correlation_results_HDAC5 <- vector()
for (i in 1:nrow(HDAC_inhibitor_df)) {
  drug_response_i_new_HDAC <- as.numeric(HDAC_inhibitor_df[i, ])
  correlation_new_5_HDAC <- cor(HDAC_concentration[32:39], drug_response_i_new_HDAC[32:39])
  plot(HDAC_concentration[32:39], drug_response_i_new_HDAC[32:39], pch = 16, col = "blue", 
       xlab = "Concentration", ylab = "Drug Response",
       main = paste("Correlation Plot - Row", i, ", Correlation:", correlation_new_5_HDAC))
  
  correlation_results_HDAC5 <- c(correlation_results_HDAC5, correlation_new_5_HDAC)
}

hist(correlation_results_HDAC5, main = "Correlation Histogram of BRD-K56957086-001-06-3", xlab = "Correlation")

#for drug 6
correlation_results_HDAC6 <- vector()
for (i in 1:nrow(HDAC_inhibitor_df)) {
  drug_response_i_new_HDAC <- as.numeric(HDAC_inhibitor_df[i, ])
  correlation_new_6_HDAC <- cor(HDAC_concentration[39:44], drug_response_i_new_HDAC[39:44])
  plot(HDAC_concentration[39:44], drug_response_i_new_HDAC[39:44], pch = 16, col = "blue", 
       xlab = "Concentration", ylab = "Drug Response",
       main = paste("Correlation Plot - Row", i, ", Correlation:", correlation_new_6_HDAC))
  
  correlation_results_HDAC6 <- c(correlation_results_HDAC6, correlation_new_6_HDAC)
}

hist(correlation_results_HDAC6, main = "Correlation Histogram of BRD-K61397605-001-03-4", xlab = "Correlation")


correlation_matrix <- matrix(c(correlation_results_HDAC1, correlation_results_HDAC2, correlation_results_HDAC3, correlation_results_HDAC4, correlation_results_HDAC5, correlation_results_HDAC6),nrow = nrow(HDAC_inhibitor_df), ncol = 6, byrow = TRUE)

rownames(correlation_matrix) <- rownames(HDAC_inhibitor_df)
colnames(correlation_matrix) <- c("BRD-K12867552-001-04-7", "BRD-K13167095-001-02-9",
                                  "BRD-K13810148-311-03-2", "RD-K17743125-001-08-4",
                                  "BRD-K56957086-001-06-3", "BRD-K61397605-001-03-4")
correlation_matrix_t <- t(correlation_matrix)
View(correlation_matrix_t)
plot.new()
install.packages("RColorBrewer")
install.packages("gplots")
library(RColorBrewer)
library(gplots)
colors <- rev(colorRampPalette(brewer.pal(9, "Blues"))(100))

par(mar = c(5, 5, 2, 2))

legend_breaks <- seq(-1, 0, length.out = length(colors) + 1)

heatmap.2(correlation_matrix,
          col = colors,
          main = "Correlation Heatmap",
          xlab = "Drug",
          ylab = "Cell",
          key = TRUE,
          keysize = 1.5,
          symkey = FALSE,  # Display only negative values on the legend
          breaks = legend_breaks,  # Specify the color legend breaks
          cex.main = 1.5,  # Adjust main title size
          cex.axis = 0.8,  # Adjust axis label size
          cex.lab = 0.8)
help("heatmap.2")
heatmap.2(correlation_matrix,
          col = colors,
          main = "Correlation Heatmap",
          xlab = "Drug",
          ylab = "Cell",
          cexRow = 0.7,
          cexCol = 0.4,
          key = TRUE,
          keysize = 1.5,
          symkey = FALSE,  # Display only negative values on the legend
          breaks = legend_breaks,  # Specify the color legend breaks
          cex.main = 1.5,  # Adjust main title size
          cex.axis = 0.8,  # Adjust axis label size
          cex.lab = 0.8) 

legend("right",
       legend = c("High", "Low"),
       fill = colors[1:2],
       bty = "n",
       title = "Correlation",
       cex = 0.8,
       y.intersp = 1.5)

heatmap(correlation_matrix,
        col = colors,
        main = "Correlation Heatmap",
        xlab = "Drug",
        ylab = "Row")



color.legend(legend = c("High", "Low"),
             gradient = c("blue", "white"),
             bty = "n",
             main = "Correlation",
             side = 4,
             cex.main = 1.2,
             cex.axis = 1,
             cex.lab = 1)


legend("right", legend = c("High", "Low"),
       fill = colors[c(1, num_colors)],
       title = "Correlation",
       bty = "n")

legend("right", legend = c("Low", "Medium", "High"),
       fill = c("blue", "white", "red"),
       title = "Correlation",
       bty = "n")
```



4.Calculating the variance:
```{r}
drug_variances <- apply(prism_celllines_matrix_transposed, 1, var)
#lets creat a histogram:
hist(drug_variances, main = "Distribution of Drug Variances", xlab = "Variance", ylab = "Frequency")
#extracting drugs with var higher than 1
selected_drugs_1 <- rownames(prism_celllines_matrix_transposed)[drug_variances > 1]
#just to prove the code
drug_variance <- drug_variances[which(rownames(prism_celllines_matrix_transposed) == "BRD-A00758722-001-04-9::10::HTS002")]
print(drug_variance)
#extracting only those drugs from the data frame:
prism_celllines_matrix_drugvariances1 <- prism_celllines_matrix_transposed[rownames(prism_celllines_matrix_transposed) %in% selected_drugs_1, ]
View (prism_celllines_matrix_drugvariances1)
#just to prove the code
drug_variances11<-apply(prism_celllines_matrix_drugvariances1, 1, var)
hist(drug_variances11, main = "Distribution of Drug Variances 1", xlab = "Variance", ylab = "Frequency")
##Now doing PCA only with these drugs:
pca_result_drugvariances1<- prcomp(prism_celllines_matrix_drugvariances1)
pca_values_drugvariances1 <- pca_result_drugvariances1$x # Principal component scores (transformed data)
pca_variances_drugvariances1 <- pca_result_drugvariances1$sdev^2  # Variance explained by each principal component
pca_proportions_drugvariances1<- pca_variances_drugvariances1/ sum(pca_variances_drugvariances1)  # Proportion of variance explained by each principal component
pca_loadings_drugvariances1 <- pca_result_drugvariances1$rotation  
# Loadings (coefficients) of each variable on each principal component

plot(1:length(pca_variances_drugvariances1), pca_variances_drugvariances1, type = "b", xlab = "Principal Component", ylab = "Variance Explained",main = "Scree Plot")

plot(pca_values_drugvariances1[, 1], pca_values_drugvariances1[, 2], xlab = "PC1", ylab = "PC2")

##now for the transposed matrix:
prism_celllines_matrix_drugvariances1_t <- t(prism_celllines_matrix_drugvariances1)
pca_result_drugvariances1_t<- prcomp(prism_celllines_matrix_drugvariances1_t)
pca_values_drugvariances1_t <- pca_result_drugvariances1_t$x # Principal component scores (transformed data)
pca_variances_drugvariances1_t <- pca_result_drugvariances1_t$sdev^2  # Variance explained by each principal component
pca_proportions_drugvariances1_t<- pca_variances_drugvariances1_t/ sum(pca_variances_drugvariances1_t)  # Proportion of variance explained by each principal component
pca_loadings_drugvariances1_t <- pca_result_drugvariances1_t$rotation  
# Loadings (coefficients) of each variable on each principal component
plot(1:length(pca_variances_drugvariances1_t), pca_variances_drugvariances1_t, type = "b", xlab = "Principal Component", ylab = "Variance Explained",main = "Scree Plot")
plot(pca_values_drugvariances1_t[, 1], pca_values_drugvariances1_t[, 2], xlab = "PC1", ylab = "PC2")


pca_data_drugvariances1_t <- data.frame(PC1 = pca_values_drugvariances1_t[, 1], PC2 = pca_values_drugvariances1_t[, 2],CellLine = rownames(pca_values_drugvariances1_t) )

bone.cancer.celllines.group<- "red"
kidney.cancer.celllines.group <- "blue"
liver.cancer.celllines.group <- "green"
gastric.cancer.celllines.group<- "purple"
breast.cancer.celllines.group <- "orange"

pca_data_drugvariances1_t$Group <- NA
pca_data_drugvariances1_t$Group[pca_data_drugvariances1_t$CellLine %in% bone.cancer.celllines.v] <- "Group 1"
pca_data_drugvariances1_t$Group[pca_data_drugvariances1_t$CellLine %in% kidney.cancer.celllines.v] <- "Group 2"
pca_data_drugvariances1_t$Group[pca_data_drugvariances1_t$CellLine %in% liver.cancer.celllines.v] <- "Group 3"
pca_data_drugvariances1_t$Group[pca_data_drugvariances1_t$CellLine %in% gastric.cancer.celllines.v] <- "Group 4"
pca_data_drugvariances1_t$Group[pca_data_drugvariances1_t$CellLine %in% breast.cancer.celllines.v]<-"Group 5"


ggplot(pca_data_drugvariances1_t, aes(x = PC1, y = PC2, color = Group)) +
  geom_point() +
  scale_color_manual(values = c(bone.cancer.celllines.group, kidney.cancer.celllines.group, liver.cancer.celllines.group, gastric.cancer.celllines.group, breast.cancer.celllines.group)) +
  labs(x = "PC1", y = "PC2", title = "PCA Scatter Plot")
```
Lets try with drugs with variance higher than 2:
```{r}
#extracting drugs with var higher than 2
selected_drugs_2 <- rownames(prism_celllines_matrix_transposed)[drug_variances > 2]
#just to prove the code
drug_variance <- drug_variances[which(rownames(prism_celllines_matrix_transposed) == "BRD-A00758722-001-04-9::10::HTS002")]
print(drug_variance)
#extracting only those drugs from the data frame:
prism_celllines_matrix_drugvariances2 <- prism_celllines_matrix_transposed[rownames(prism_celllines_matrix_transposed) %in% selected_drugs_2, ]
View (prism_celllines_matrix_drugvariances2)
#just to prove the code
drug_variances22<-apply(prism_celllines_matrix_drugvariances2, 1, var)
hist(drug_variances22, main = "Distribution of Drug Variances 1", xlab = "Variance", ylab = "Frequency")
##Now doing PCA only with these drugs:
pca_result_drugvariances2<- prcomp(prism_celllines_matrix_drugvariances2)
pca_values_drugvariances2 <- pca_result_drugvariances2$x # Principal component scores (transformed data)
pca_variances_drugvariances2 <- pca_result_drugvariances2$sdev^2  # Variance explained by each principal component
pca_proportions_drugvariances2<- pca_variances_drugvariances2/ sum(pca_variances_drugvariances2)  # Proportion of variance explained by each principal component
pca_loadings_drugvariances2 <- pca_result_drugvariances2$rotation  
# Loadings (coefficients) of each variable on each principal component

plot(1:length(pca_variances_drugvariances2), pca_variances_drugvariances2, type = "b", xlab = "Principal Component", ylab = "Variance Explained",main = "Scree Plot")

plot(pca_values_drugvariances2[, 1], pca_values_drugvariances2[, 2], xlab = "PC1", ylab = "PC2")

##now for the transposed matrix:
prism_celllines_matrix_drugvariances2_t <- t(prism_celllines_matrix_drugvariances2)
pca_result_drugvariances2_t<- prcomp(prism_celllines_matrix_drugvariances2_t)
pca_values_drugvariances2_t <- pca_result_drugvariances2_t$x # Principal component scores (transformed data)
pca_variances_drugvariances2_t <- pca_result_drugvariances2_t$sdev^2  # Variance explained by each principal component
pca_proportions_drugvariances2_t<- pca_variances_drugvariances2_t/ sum(pca_variances_drugvariances2_t)  # Proportion of variance explained by each principal component
pca_loadings_drugvariances2_t <- pca_result_drugvariances2_t$rotation  
# Loadings (coefficients) of each variable on each principal component
plot(1:length(pca_variances_drugvariances2_t), pca_variances_drugvariances2_t, type = "b", xlab = "Principal Component", ylab = "Variance Explained",main = "Scree Plot")
plot(pca_values_drugvariances2_t[, 1], pca_values_drugvariances2_t[, 2], xlab = "PC1", ylab = "PC2")


pca_data_drugvariances2_t <- data.frame(PC1 = pca_values_drugvariances2_t[, 1], PC2 = pca_values_drugvariances2_t[, 2],CellLine = rownames(pca_values_drugvariances2_t) )

bone.cancer.celllines.group<- "red"
kidney.cancer.celllines.group <- "blue"
liver.cancer.celllines.group <- "green"
gastric.cancer.celllines.group<- "purple"
breast.cancer.celllines.group <- "orange"

pca_data_drugvariances2_t$Group <- NA
pca_data_drugvariances2_t$Group[pca_data_drugvariances2_t$CellLine %in% bone.cancer.celllines.v] <- "Group 1"
pca_data_drugvariances2_t$Group[pca_data_drugvariances2_t$CellLine %in% kidney.cancer.celllines.v] <- "Group 2"
pca_data_drugvariances2_t$Group[pca_data_drugvariances2_t$CellLine %in% liver.cancer.celllines.v] <- "Group 3"
pca_data_drugvariances2_t$Group[pca_data_drugvariances2_t$CellLine %in% gastric.cancer.celllines.v] <- "Group 4"
pca_data_drugvariances2_t$Group[pca_data_drugvariances2_t$CellLine %in% breast.cancer.celllines.v]<-"Group 5"


ggplot(pca_data_drugvariances2_t, aes(x = PC1, y = PC2, color = Group)) +
  geom_point() +
  scale_color_manual(values = c(bone.cancer.celllines.group, kidney.cancer.celllines.group, liver.cancer.celllines.group, gastric.cancer.celllines.group, breast.cancer.celllines.group)) +
  labs(x = "PC1", y = "PC2", title = "PCA Scatter Plot")
```
``` Testing sth:
```{r}
#extracting drugs with var higher than 2
selected_drugs_2 <- rownames(prism_celllines_matrix_transposed)[drug_variances > 2]
#just to prove the code
drug_variance <- drug_variances[which(rownames(prism_celllines_matrix_transposed) == "BRD-A00758722-001-04-9::10::HTS002")]
print(drug_variance)
#extracting only those drugs from the data frame:
prism_celllines_matrix_drugvariances2 <- prism_celllines_matrix_transposed[rownames(prism_celllines_matrix_transposed) %in% selected_drugs_2, ]
View (prism_celllines_matrix_drugvariances2)
#just to prove the code
drug_variances22<-apply(prism_celllines_matrix_drugvariances2, 1, var)
hist(drug_variances22, main = "Distribution of Drug Variances 1", xlab = "Variance", ylab = "Frequency")
##Now doing PCA only with these drugs:
pca_result_drugvariances2_sc<- prcomp(prism_celllines_matrix_drugvariances2, scale = FALSE)
pca_values_drugvariances2_sc <- pca_result_drugvariances2_sc$x # Principal component scores (transformed data)
pca_variances_drugvariances2_sc <- pca_result_drugvariances2_sc$sdev^2  # Variance explained by each principal component
pca_proportions_drugvariances2_sc<- pca_variances_drugvariances2_sc/ sum(pca_variances_drugvariances2_sc)  # Proportion of variance explained by each principal component
pca_loadings_drugvariances2_sc <- pca_result_drugvariances2_sc$rotation  
# Loadings (coefficients) of each variable on each principal component

plot(1:length(pca_variances_drugvariances2_sc), pca_variances_drugvariances2_sc, type = "b", xlab = "Principal Component", ylab = "Variance Explained",main = "Scree Plot")

plot(pca_values_drugvariances2_sc[, 1], pca_values_drugvariances2_sc[, 2], xlab = "PC1", ylab = "PC2")

##now for the transposed matrix:
prism_celllines_matrix_drugvariances2_t <- t(prism_celllines_matrix_drugvariances2)
pca_result_drugvariances2_t_sc<- prcomp(prism_celllines_matrix_drugvariances2_t, scale = FALSE)
pca_values_drugvariances2_t_sc <- pca_result_drugvariances2_t_sc$x # Principal component scores (transformed data)
pca_variances_drugvariances2_t_sc <- pca_result_drugvariances2_t_sc$sdev^2  # Variance explained by each principal component
pca_proportions_drugvariances2_t_sc<- pca_variances_drugvariances2_t_sc/ sum(pca_variances_drugvariances2_t_sc)  # Proportion of variance explained by each principal component
pca_loadings_drugvariances2_t_sc <- pca_result_drugvariances2_t_sc$rotation  
# Loadings (coefficients) of each variable on each principal component
plot(1:length(pca_variances_drugvariances2_t), pca_variances_drugvariances2_t, type = "b", xlab = "Principal Component", ylab = "Variance Explained",main = "Scree Plot")
plot(pca_values_drugvariances2_t_sc[, 1], pca_values_drugvariances2_t_sc[, 2], xlab = "PC1", ylab = "PC2")


pca_data_drugvariances2_t <- data.frame(PC1 = pca_values_drugvariances2_t[, 1], PC2 = pca_values_drugvariances2_t[, 2],CellLine = rownames(pca_values_drugvariances2_t) )

bone.cancer.celllines.group<- "red"
kidney.cancer.celllines.group <- "blue"
liver.cancer.celllines.group <- "green"
gastric.cancer.celllines.group<- "purple"
breast.cancer.celllines.group <- "orange"

pca_data_drugvariances2_t$Group <- NA
pca_data_drugvariances2_t$Group[pca_data_drugvariances2_t$CellLine %in% bone.cancer.celllines.v] <- "Group 1"
pca_data_drugvariances2_t$Group[pca_data_drugvariances2_t$CellLine %in% kidney.cancer.celllines.v] <- "Group 2"
pca_data_drugvariances2_t$Group[pca_data_drugvariances2_t$CellLine %in% liver.cancer.celllines.v] <- "Group 3"
pca_data_drugvariances2_t$Group[pca_data_drugvariances2_t$CellLine %in% gastric.cancer.celllines.v] <- "Group 4"
pca_data_drugvariances2_t$Group[pca_data_drugvariances2_t$CellLine %in% breast.cancer.celllines.v]<-"Group 5"


ggplot(pca_data_drugvariances2_t, aes(x = PC1, y = PC2, color = Group)) +
  geom_point() +
  scale_color_manual(values = c(bone.cancer.celllines.group, kidney.cancer.celllines.group, liver.cancer.celllines.group, gastric.cancer.celllines.group, breast.cancer.celllines.group)) +
  labs(x = "PC1", y = "PC2", title = "PCA Scatter Plot")
```
```{r}
#extracting drugs with var higher than 3
selected_drugs_3 <- rownames(prism_celllines_matrix_transposed)[drug_variances > 3]
#just to prove the code
drug_variance <- drug_variances[which(rownames(prism_celllines_matrix_transposed) == "BRD-A00758722-001-04-9::10::HTS002")]
print(drug_variance)
#extracting only those drugs from the data frame:
prism_celllines_matrix_drugvariances3 <- prism_celllines_matrix_transposed[rownames(prism_celllines_matrix_transposed) %in% selected_drugs_3, ]
View (prism_celllines_matrix_drugvariances3)
#just to prove the code
drug_variances33<-apply(prism_celllines_matrix_drugvariances3, 1, var)
hist(drug_variances33, main = "Distribution of Drug Variances 3", xlab = "Variance", ylab = "Frequency")
##Now doing PCA only with these drugs:
pca_result_drugvariances3<- prcomp(prism_celllines_matrix_drugvariances3)
pca_values_drugvariances3 <- pca_result_drugvariances3$x # Principal component scores (transformed data)
pca_variances_drugvariances3 <- pca_result_drugvariances3$sdev^2  # Variance explained by each principal component
pca_proportions_drugvariances3<- pca_variances_drugvariances3/ sum(pca_variances_drugvariances3)  # Proportion of variance explained by each principal component
pca_loadings_drugvariances3 <- pca_result_drugvariances3$rotation  
# Loadings (coefficients) of each variable on each principal component

plot(1:length(pca_variances_drugvariances3), pca_variances_drugvariances3, type = "b", xlab = "Principal Component", ylab = "Variance Explained",main = "Scree Plot")

plot(pca_values_drugvariances3[, 1], pca_values_drugvariances3[, 2], xlab = "PC1", ylab = "PC2")

##now for the transposed matrix:
prism_celllines_matrix_drugvariances3_t <- t(prism_celllines_matrix_drugvariances3)
View(prism_celllines_matrix_drugvariances3_t)
pca_result_drugvariances3_t<- prcomp(prism_celllines_matrix_drugvariances3_t)
pca_values_drugvariances3_t <- pca_result_drugvariances3_t$x # Principal component scores (transformed data)
pca_variances_drugvariances3_t <- pca_result_drugvariances3_t$sdev^2  # Variance explained by each principal component
pca_proportions_drugvariances3_t<- pca_variances_drugvariances3_t/ sum(pca_variances_drugvariances3_t)  # Proportion of variance explained by each principal component
pca_loadings_drugvariances3_t <- pca_result_drugvariances3_t$rotation  
# Loadings (coefficients) of each variable on each principal component
plot(1:length(pca_variances_drugvariances3_t), pca_variances_drugvariances3_t, type = "b", xlab = "Principal Component", ylab = "Variance Explained",main = "Scree Plot")
plot(pca_values_drugvariances3_t[, 1], pca_values_drugvariances3_t[, 2], xlab = "PC1", ylab = "PC2")


pca_data_drugvariances3_t <- data.frame(PC1 = pca_values_drugvariances3_t[, 1], PC2 = pca_values_drugvariances3_t[, 2],CellLine = rownames(pca_values_drugvariances3_t) )

bone.cancer.celllines.group<- "red"
kidney.cancer.celllines.group <- "blue"
liver.cancer.celllines.group <- "green"
gastric.cancer.celllines.group<- "purple"
breast.cancer.celllines.group <- "orange"

pca_data_drugvariances3_t$Group <- NA
pca_data_drugvariances3_t$Group[pca_data_drugvariances3_t$CellLine %in% bone.cancer.celllines.v] <- "Group 1"
pca_data_drugvariances3_t$Group[pca_data_drugvariances3_t$CellLine %in% kidney.cancer.celllines.v] <- "Group 2"
pca_data_drugvariances3_t$Group[pca_data_drugvariances3_t$CellLine %in% liver.cancer.celllines.v] <- "Group 3"
pca_data_drugvariances3_t$Group[pca_data_drugvariances3_t$CellLine %in% gastric.cancer.celllines.v] <- "Group 4"
pca_data_drugvariances3_t$Group[pca_data_drugvariances3_t$CellLine %in% breast.cancer.celllines.v]<-"Group 5"


ggplot(pca_data_drugvariances3_t, aes(x = PC1, y = PC2, color = Group)) +
  geom_point() +
  scale_color_manual(values = c(bone.cancer.celllines.group, kidney.cancer.celllines.group, liver.cancer.celllines.group, gastric.cancer.celllines.group, breast.cancer.celllines.group)) +
  labs(x = "PC1", y = "PC2", title = "PCA Scatter Plot")
```

```{r}
#extracting drugs with var higher than 5
selected_drugs_5 <- rownames(prism_celllines_matrix_transposed)[drug_variances > 5]

#extracting only those drugs from the data frame:
prism_celllines_matrix_drugvariances5 <- prism_celllines_matrix_transposed[rownames(prism_celllines_matrix_transposed) %in% selected_drugs_5, ]
View (prism_celllines_matrix_drugvariances5)
#just to prove the code
drug_variances55<-apply(prism_celllines_matrix_drugvariances5, 1, var)
hist(drug_variances55, main = "Distribution of Drug Variances 5", xlab = "Variance", ylab = "Frequency")
##Now doing PCA only with these drugs:
pca_result_drugvariances5<- prcomp(prism_celllines_matrix_drugvariances5)
pca_values_drugvariances5 <- pca_result_drugvariances5$x # Principal component scores (transformed data)
pca_variances_drugvariances5 <- pca_result_drugvariances5$sdev^2  # Variance explained by each principal component
pca_proportions_drugvariances5<- pca_variances_drugvariances5/ sum(pca_variances_drugvariances5)  # Proportion of variance explained by each principal component
pca_loadings_drugvariances5 <- pca_result_drugvariances5$rotation  
# Loadings (coefficients) of each variable on each principal component

plot(1:length(pca_variances_drugvariances5), pca_variances_drugvariances5, type = "b", xlab = "Principal Component", ylab = "Variance Explained",main = "Scree Plot")

plot(pca_values_drugvariances5[, 1], pca_values_drugvariances5[, 2], xlab = "PC1", ylab = "PC2")

##now for the transposed matrix:
prism_celllines_matrix_drugvariances5_t <- t(prism_celllines_matrix_drugvariances5)
pca_result_drugvariances5_t<- prcomp(prism_celllines_matrix_drugvariances5_t)
pca_values_drugvariances5_t <- pca_result_drugvariances5_t$x # Principal component scores (transformed data)
pca_variances_drugvariances5_t <- pca_result_drugvariances5_t$sdev^2  # Variance explained by each principal component
pca_proportions_drugvariances5_t<- pca_variances_drugvariances5_t/ sum(pca_variances_drugvariances5_t)  # Proportion of variance explained by each principal component
pca_loadings_drugvariances5_t <- pca_result_drugvariances5_t$rotation  
# Loadings (coefficients) of each variable on each principal component
plot(1:length(pca_variances_drugvariances5_t), pca_variances_drugvariances5_t, type = "b", xlab = "Principal Component", ylab = "Variance Explained",main = "Scree Plot")
plot(pca_values_drugvariances5_t[, 1], pca_values_drugvariances5_t[, 2], xlab = "PC1", ylab = "PC2")


pca_data_drugvariances5_t <- data.frame(PC1 = pca_values_drugvariances5_t[, 1], PC2 = pca_values_drugvariances5_t[, 2],CellLine = rownames(pca_values_drugvariances5_t) )

bone.cancer.celllines.group<- "red"
kidney.cancer.celllines.group <- "blue"
liver.cancer.celllines.group <- "green"
gastric.cancer.celllines.group<- "purple"
breast.cancer.celllines.group <- "orange"

pca_data_drugvariances5_t$Group <- NA
pca_data_drugvariances5_t$Group[pca_data_drugvariances5_t$CellLine %in% bone.cancer.celllines.v] <- "Group 1"
pca_data_drugvariances5_t$Group[pca_data_drugvariances5_t$CellLine %in% kidney.cancer.celllines.v] <- "Group 2"
pca_data_drugvariances5_t$Group[pca_data_drugvariances5_t$CellLine %in% liver.cancer.celllines.v] <- "Group 3"
pca_data_drugvariances5_t$Group[pca_data_drugvariances5_t$CellLine %in% gastric.cancer.celllines.v] <- "Group 4"
pca_data_drugvariances5_t$Group[pca_data_drugvariances5_t$CellLine %in% breast.cancer.celllines.v]<-"Group 5"


ggplot(pca_data_drugvariances5_t, aes(x = PC1, y = PC2, color = Group)) +
  geom_point() +
  scale_color_manual(values = c(bone.cancer.celllines.group, kidney.cancer.celllines.group, liver.cancer.celllines.group, gastric.cancer.celllines.group, breast.cancer.celllines.group)) +
  labs(x = "PC1", y = "PC2", title = "PCA Scatter Plot")
```
**Reducing the dataframe prism_celllines_matrix_filtered1 to just the genes that show high variance within a cancertype to see if the clustering based on PCA differs :**
```{r}
#First Step:

#Create dataframes with just the cellines from one of the five cancer types:




#Gastric cancer Dataframe of Prism.exp
G.prism.filtered<-prism_celllines_matrix_filtered1[rownames(prism_celllines_matrix_filtered1) %in% gastric.cancer.celllines.v, ]
#Kidney cancer Dataframe of Prism.exp
K.prism.filtered<-prism_celllines_matrix_filtered1[rownames(prism_celllines_matrix_filtered1) %in% kidney.cancer.celllines.v, ]
#Bone cancer Dataframe of Prism.exp
B.prism.filtered<-prism_celllines_matrix_filtered1[rownames(prism_celllines_matrix_filtered1) %in% bone.cancer.celllines.v, ]
#Breast cancer Dataframe of Prism.exp
Br.prism.filtered<-prism_celllines_matrix_filtered1[rownames(prism_celllines_matrix_filtered1) %in% breast.cancer.celllines.v, ]
#Liver cancer Dataframe of Prism.exp
L.prism.filtered<-prism_celllines_matrix_filtered1[rownames(prism_celllines_matrix_filtered1) %in% liver.cancer.celllines.v, ]
```

Second step:

Transpose those dataframes to calculate the variance of each row so from the gene expression of one gene :

```{r}
# Transpose the dataframes
t.G.prism.filtered <- t(G.prism.filtered)
t.K.prism.filtered<- t(K.prism.filtered)
t.B.prism.filtered<- t(B.prism.filtered)
t.Br.prism.filtered<-t(Br.prism.filtered)
t.L.prism.filtered<-t(L.prism.filtered)
```

```{r}
# Calculate the variance of each row of the dataframes cancertypes

G.drug.filtered_variances <- apply(t.G.prism.filtered, MARGIN = 1, var)
K.drug.filtered_variances <- apply(t.K.prism.filtered, MARGIN = 1, var)
B.drug.filtered_variances <- apply(t.B.prism.filtered, MARGIN = 1, var)
Br.drug.filtered_variances <- apply(t.Br.prism.filtered, MARGIN = 1, var)
L.drug.filtered_variances <- apply(t.L.prism.filtered, MARGIN = 1, var)
```

```{r}
#plotting the variances to define a logical treshold for selecting drugs
hist(G.drug.filtered_variances)
hist(K.drug.filtered_variances)
hist(L.drug.filtered_variances)
hist(B.drug.filtered_variances)
hist(Br.drug.filtered_variances)
```
Tresholds:

Gatsric Cancer: 4

Kidney Cancer: 5

Liver Cancer: 6

Bone Cancer : 6

Breast Cancer 5

```{r}
threshold1 <- 4
G.selected_drugs_var <- t.G.prism.filtered[G.drug.filtered_variances > threshold1, ]
threshold2 <- 5
K.selected_drugs_var <- t.K.prism.filtered[K.drug.filtered_variances > threshold2, ]
threshold3 <- 6
L.selected_drugs_var <- t.L.prism.filtered[L.drug.filtered_variances > threshold3, ]
threshold4 <- 6
B.selected_drugs_var <- t.B.prism.filtered[B.drug.filtered_variances > threshold4, ]
threshold5 <- 5
Br.selected_drugs_var <- t.Br.prism.filtered[Br.drug.filtered_variances > threshold5, ]
```

```{r}
G.prism.drugs.var<-t(G.selected_drugs_var)
K.prism.drugs.var<-t(K.selected_drugs_var)
L.prism.drugs.var<-t(L.selected_drugs_var)
B.prism.drugs.var<-t(B.selected_drugs_var)
Br.prism.drugs.var<-t(Br.selected_drugs_var)
```

Step 3: Creating a new dataframe of prism.exp with all genes that are left in the dataframes reduced to the genes showing high variance within a cancer type:

```{r}
G.column_names <- colnames(G.prism.drugs.var)
K.column_names <- colnames(K.prism.drugs.var)
L.column_names <- colnames(L.prism.drugs.var)
B.column_names <- colnames(B.prism.drugs.var)
Br.column_names <- colnames(Br.prism.drugs.var)

```

```{r}
genes_variance.V <- c(G.column_names,K.column_names,L.column_names,B.column_names,Br.column_names)
```

```{r}
prism.filtered1_drugs_variances <- prism_celllines_matrix_filtered1[,colnames( prism_celllines_matrix_filtered1) %in% genes_variance.V ]


pca_result_prism.filtered1_drugs_variances <- prcomp(prism.filtered1_drugs_variances)
pca_values_prism.filtered1_drugs_variances <- pca_result_prism.filtered1_drugs_variances $x # Principal component scores (transformed data)
pca_variances_prism.filtered1_drugs_variances <- pca_result_prism.filtered1_drugs_variances $sdev^2  # Variance explained by each principal component
pca_proportions_prism.filtered1_drugs_variance <- pca_variances_prism.filtered1_drugs_variances / sum(pca_variances_prism.filtered1_drugs_variances)  # Proportion of variance explained by each principal component
pca_loadings_prism.filtered1_drugs_variances <- pca_result_prism.filtered1_drugs_variances $rotation  # Loadings (coefficients) of each variable on each principal component
 plot(1:length(pca_variances_prism.filtered1_drugs_variances), pca_variances_prism.filtered1_drugs_variances, type = "b", xlab = "Principal Component", ylab = "Variance Explained",
     main = "Scree Plot")
plot(pca_values_prism.filtered1_drugs_variances[, 1], pca_values_prism.filtered1_drugs_variances[, 2], xlab = "PC1", ylab = "PC2")


###
pca_data_prism.filtered1_drugs_variances <- data.frame(PC1 = pca_values_prism.filtered1_drugs_variances[, 1], PC2 = pca_values_prism.filtered1_drugs_variances[, 2],CellLine = rownames(pca_values_prism.filtered1_drugs_variances) )

pca_data_prism.filtered1_drugs_variances_PC <- data.frame(PC1 = pca_values_prism.filtered1_drugs_variances[, 1], PC2 = pca_values_prism.filtered1_drugs_variances[, 2])

bone.cancer.celllines.group<- "red"
kidney.cancer.celllines.group <- "blue"
liver.cancer.celllines.group <- "green"
gastric.cancer.celllines.group<- "purple"
breast.cancer.celllines.group <- "orange"

pca_data_prism.filtered1_drugs_variances$Group <- NA
pca_data_prism.filtered1_drugs_variances$Group[pca_data_prism.filtered1_drugs_variances$CellLine %in% bone.cancer.celllines.v] <- "Bone cancer"
pca_data_prism.filtered1_drugs_variances$Group[pca_data_prism.filtered1_drugs_variances$CellLine %in% kidney.cancer.celllines.v] <- "Kidney cancer"
pca_data_prism.filtered1_drugs_variances$Group[pca_data_prism.filtered1_drugs_variances$CellLine %in% liver.cancer.celllines.v] <- "Liver cancer"
pca_data_prism.filtered1_drugs_variances$Group[pca_data_prism.filtered1_drugs_variances$CellLine %in% gastric.cancer.celllines.v] <- "Gastric cancer"
pca_data_prism.filtered1_drugs_variances$Group[pca_data_prism.filtered1_drugs_variances$CellLine %in% breast.cancer.celllines.v]<-"Breast cancer"

library(ggplot2)
ggplot(pca_data_prism.filtered1_drugs_variances, aes(x = PC1, y = PC2, color = Group)) +
  geom_point() +
  scale_color_manual(values = c("Bone cancer" = bone.cancer.celllines.group,"Kidney cancer" = kidney.cancer.celllines.group, "Liver cancer" = liver.cancer.celllines.group, "Gastric cancer" =  gastric.cancer.celllines.group, "Breast cancer" = breast.cancer.celllines.group)) +
  labs(x = "PC1", y = "PC2", title = "PCA Scatter Plot")

pc_scores_prism <- as.data.frame(pca_result_prism.filtered1_drugs_variances$x[, 1:2])
kmeans_result_prism <- kmeans(pc_scores_prism, centers = 4)

# Add cluster labels to the PC scores
pc_scores_prism$cluster <- as.factor(kmeans_result_prism$cluster)

# Plot the clustered data
ggplot(pc_scores_prism, aes(PC1, PC2, color = cluster)) +
  geom_point() +
  labs(x = "PC1", y = "PC2", title = "PCA with K-means Clustering")

cluster_centers_prism <- aggregate(pc_scores_prism[, c("PC1", "PC2")], list(cluster = pc_scores_prism$cluster), mean)
cluster_radii_prism <- aggregate(pc_scores_prism[, c("PC1", "PC2")], list(cluster = pc_scores_prism$cluster), function(x) max(dist(rbind(x, c(0, 0)))))
ggplot(pc_scores_prism, aes(PC1, PC2, color = cluster)) +
  geom_point() +stat_ellipse(geom = "path", aes(group = cluster, color = cluster), alpha = 0.2)+
  labs(x = "PC1", y = "PC2", title = "PCA with K-means Clustering and Circles")

#testing the right number of clusters:
library(cluster)
library(factoextra)
install.packages ("factoextra")


fviz_nbclust(pca_data_prism.filtered1_drugs_variances_PC, kmeans, method = "wss") + geom_vline(xintercept = 4, linetype=2)
 #it works ith pc_scpres_prism in the same way, so both are correct
  

View(prism.filtered1_drugs_variances)
#trying things
install.packages("NbClust")
library(NbClust)
clusternum <- NbClust ((pc_scores_prism), distance="euclidean", method="kmeans")

pam.res5 <- pam(pc_scores_prism, 5,  metric = "euclidean", stand = FALSE)
fviz_cluster(pam.res5, data = pc_scores_prism, palette = c("#FC4E07", "#00AFBB", "#E7B800","#4C8C33", "#8C4599"), ellipse.type = "euclid", 
star.plot = TRUE, 
repel = TRUE, 
ggtheme = theme_minimal(), geom = "point" )

install.packages("tidyverse")
library(purrr)

fviz_silhouette(pam.res5, palette = "jco", ggtheme = theme_classic())
#higher values indicates a better clustering
avg_sil <- function(k) {
  km.res <- kmeans(pc_scores_prism, centers = 5, nstart = 25)
  ss <- silhouette(km.res$cluster, dist(pc_scores_prism))
  mean(ss[, 3])
  }
#compute and plot wss for k=2 to k=15
k.values <- 2:15

# extract avg silhouette for 2-15 clusters
avg_sil_values <- map_dbl(k.values, avg_sil)

plot(k.values, avg_sil_values,
       type = "b", pch = 19, frame = FALSE, 
       xlab = "Number of clusters K",
       ylab = "Average Silhouettes")

#computing with silhouette method
fviz_nbclust(pc_scores_prism, kmeans, method = "silhouette")




pam.res4 <- pam(pc_scores_prism, 4,  metric = "euclidean", stand = FALSE)
fviz_cluster(pam.res4, data = pc_scores_prism, palette = c("#FC4E07", "#00AFBB", "#E7B800","#4C8C33"), ellipse.type = "euclid", 
star.plot = TRUE, 
repel = TRUE, 
ggtheme = theme_minimal(),geom = "point" )

fviz_silhouette(pam.res4, palette = "jco", ggtheme = theme_classic())
#In our case, an average silhouette width of 0.41 indicates a moderate to good separation of data points within their respective clusters. This suggests that the clustering result has some level of distinction and coherence, with a reasonably clear separation between the clusters
 #trying with other numbers:
pam.res2 <- pam(pc_scores_prism, 2,  metric = "euclidean", stand = FALSE)
fviz_cluster(pam.res2, data = pc_scores_prism, palette = c("#FC4E07", "#00AFBB"), ellipse.type = "euclid", 
star.plot = TRUE, 
repel = TRUE, 
ggtheme = theme_minimal())

fviz_silhouette(pam.res5, palette = "jco", ggtheme = theme_classic())

#here we have 0.49, which is even better

pam.res6 <- pam(pc_scores_prism, 6,  metric = "euclidean", stand = FALSE)
fviz_cluster(pam.res6, data = pc_scores_prism, palette = c("#FC4E07", "#00AFBB", "#E7B800","#4C8C33", "#8C4599", "#4DB3E6"), ellipse.type = "euclid", 
star.plot = TRUE, 
repel = TRUE, 
ggtheme = theme_minimal(), geom = "point")
 #it does not work with 6 because too few points to calculate an ellipse





#the same for the transposed matrix:
prism.filtered1_drugs_variances_t <- t(prism.filtered1_drugs_variances)
pca_result_prism.filtered1_drugs_variances_t <- prcomp(prism.filtered1_drugs_variances_t)
pca_values_prism.filtered1_drugs_variances_t <- pca_result_prism.filtered1_drugs_variances_t $x # Principal component scores (transformed data)
pca_variances_prism.filtered1_drugs_variances_t <- pca_result_prism.filtered1_drugs_variances_t $sdev^2  # Variance explained by each principal component
pca_proportions_prism.filtered1_drugs_variance_t <- pca_variances_prism.filtered1_drugs_variances_t / sum(pca_variances_prism.filtered1_drugs_variances_t)  # Proportion of variance explained by each principal component
pca_loadings_prism.filtered1_drugs_variances_t <- pca_result_prism.filtered1_drugs_variances_t $rotation  # Loadings (coefficients) of each variable on each principal component
 plot(1:length(pca_variances_prism.filtered1_drugs_variances_t), pca_variances_prism.filtered1_drugs_variances_t, type = "b", xlab = "Principal Component", ylab = "Variance Explained",
     main = "Scree Plot")
plot(pca_values_prism.filtered1_drugs_variances_t[, 1], pca_values_prism.filtered1_drugs_variances_t[, 2], xlab = "PC1", ylab = "PC2")


pc_scores_prism_t <- as.data.frame(pca_result_prism.filtered1_drugs_variances_t$x[, 1:2])
kmeans_result_prism_t <- kmeans(pc_scores_prism_t, centers = 4)

# Add cluster labels to the PC scores
pc_scores_prism_t$cluster <- as.factor(kmeans_result_prism_t$cluster)

# Plot the clustered data
ggplot(pc_scores_prism_t, aes(PC1, PC2, color = cluster)) +
  geom_point() +
  labs(x = "PC1", y = "PC2", title = "PCA with K-means Clustering")

cluster_centers_prism_t <- aggregate(pc_scores_prism_t[, c("PC1", "PC2")], list(cluster = pc_scores_prism_t$cluster), mean)
cluster_radii_prism_t <- aggregate(pc_scores_prism_t[, c("PC1", "PC2")], list(cluster = pc_scores_prism_t$cluster), function(x) max(dist(rbind(x, c(0, 0)))))
ggplot(pc_scores_prism_t, aes(PC1, PC2, color = cluster)) +
  geom_point() +stat_ellipse(geom = "path", aes(group = cluster, color = cluster), alpha = 0.2)+
  labs(x = "PC1", y = "PC2", title = "PCA with K-means Clustering and Circles")


library(cluster)
library(factoextra)
fviz_nbclust(pc_scores_prism_t, kmeans, method = "wss") + geom_vline(xintercept = 5, linetype=2)
 #it works ith pc_scpres_prism in the same way, so both are correct
  

View(prism.filtered1_drugs_variances)
#trying things
install.packages("NbClust")
library(NbClust)
clusternum <- NbClust ((pc_scores_prism), distance="euclidean", method="kmeans")

pam.res5_t <- pam(pc_scores_prism_t, 5,  metric = "euclidean", stand = FALSE)
fviz_cluster(pam.res5_t, data = pc_scores_prism_t, palette = c("#FC4E07", "#00AFBB", "#E7B800","#4C8C33", "#8C4599"), ellipse.type = "euclid", 
star.plot = TRUE, 
repel = TRUE, 
ggtheme = theme_minimal(), geom = "point" )

install.packages("tidyverse")
library(purrr)

fviz_silhouette(pam.res5_t, palette = "jco", ggtheme = theme_classic())
#higher values indicates a better clustering
avg_sil_t <- function(k) {
  km.res_t <- kmeans(pc_scores_prism_t, centers = 5, nstart = 25)
  ss_t <- silhouette(km.res_t$cluster, dist(pc_scores_prism_t))
  mean(ss_t[, 3])
  }
#compute and plot wss for k=2 to k=15
k.values_t <- 2:15

# extract avg silhouette for 2-15 clusters
avg_sil_values_t <- map_dbl(k.values_t, avg_sil_t)

plot(k.values_t, avg_sil_values_t,
       type = "b", pch = 19, frame = FALSE, 
       xlab = "Number of clusters K",
       ylab = "Average Silhouettes")

#computing with silhouette method
fviz_nbclust(pc_scores_prism_t, kmeans, method = "silhouette")




pam.res4_t <- pam(pc_scores_prism_t, 4,  metric = "euclidean", stand = FALSE)
fviz_cluster(pam.res4_t, data = pc_scores_prism_t, palette = c("#FC4E07", "#00AFBB", "#E7B800","#4C8C33"), ellipse.type = "euclid", 
star.plot = TRUE, 
repel = TRUE, 
ggtheme = theme_minimal(),geom = "point" )

fviz_silhouette(pam.res4_t, palette = "jco", ggtheme = theme_classic())
pam.res6_t <- pam(pc_scores_prism_t, 6,  metric = "euclidean", stand = FALSE)
fviz_cluster(pam.res6_t, data = pc_scores_prism_t, palette = c("#FC4E07", "#00AFBB", "#E7B800","#4C8C33", "#8C4599", "#4DB3E6"), ellipse.type = "euclid", 
star.plot = TRUE, 
repel = TRUE, 
ggtheme = theme_minimal(), geom = "point")
fviz_silhouette(pam.res6_t, palette = "jco", ggtheme = theme_classic())


pam.res3_t <- pam(pc_scores_prism_t, 3,  metric = "euclidean", stand = FALSE)
fviz_cluster(pam.res3_t, data = pc_scores_prism_t, palette = c("#FC4E07", "#00AFBB", "#E7B800"), ellipse.type = "euclid", 
star.plot = TRUE, 
repel = TRUE, 
ggtheme = theme_minimal(), geom = "point")
fviz_silhouette(pam.res3_t, palette = "jco", ggtheme = theme_classic())




PCA of this reduced data frame: 
```{r}
standardized_data.p <- scale(prism_cleaned)
pca_result.p <- prcomp(standardized_data.p, scale. = FALSE)
View(pca_result.p)
pcs <- pca_result.p$x
variance_explained <- pca_result.p$sdev^2 / sum(pca_result.p$sdev^2)

loadings <- pca_result.p$rotation
scree_plot <- plot(1:length(variance_explained), variance_explained, type = "b",  xlab = "Principal Component", ylab = "Variance Explained")

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
